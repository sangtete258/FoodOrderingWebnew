@model FoodOrderingWeb.Models.ViewModels.CheckoutViewModel
@{
    ViewData["Title"] = "Thanh toán";
}

<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-credit-card"></i> Thanh toán đơn hàng</h2>

    <div class="row">
        <!-- Form nhập thông tin -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-circle"></i> Thông tin giao hàng</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Checkout" method="post" id="checkoutForm" data-validation="true">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="CustomerName" class="form-label">
                                <i class="bi bi-person"></i> Họ và tên <span class="text-danger">*</span>
                            </label>
                            <input asp-for="CustomerName" class="form-control" placeholder="Nguyễn Văn A" />
                            <span asp-validation-for="CustomerName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PhoneNumber" class="form-label">
                                <i class="bi bi-telephone"></i> Số điện thoại <span class="text-danger">*</span>
                            </label>
                            <input asp-for="PhoneNumber" class="form-control" placeholder="0912345678" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">
                                <i class="bi bi-envelope"></i> Email (nhận thông báo đơn hàng)
                            </label>
                            <input asp-for="Email" type="email" class="form-control" placeholder="example@email.com" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="DeliveryAddress" class="form-label">
                                <i class="bi bi-geo-alt"></i> Địa chỉ giao hàng <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="DeliveryAddress"
                                      class="form-control"
                                      rows="3"
                                      id="deliveryAddress"
                                      placeholder="Số nhà, đường, phường/xã, quận/huyện, Nha Trang, Khánh Hòa"></textarea>
                            <span asp-validation-for="DeliveryAddress" class="text-danger"></span>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Nhập địa chỉ chi tiết để tính phí ship chính xác
                            </small>
                        </div>

                        <!-- Hiển thị khu vực ship được nhận diện -->
                        <div id="shippingAreaInfo" class="alert alert-info d-none mb-3">
                            <i class="bi bi-truck"></i> <strong>Khu vực:</strong> <span id="areaName"></span>
                            <span id="distanceInfo" class="ms-2"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Note" class="form-label">
                                <i class="bi bi-sticky"></i> Ghi chú đơn hàng
                            </label>
                            <textarea asp-for="Note" class="form-control" rows="2"
                                      placeholder="Ghi chú thêm cho người giao hàng (tùy chọn)"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                <i class="bi bi-check-circle"></i> Xác nhận đặt hàng
                            </button>
                            <a asp-controller="Cart" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Quay lại giỏ hàng
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Thông tin đơn hàng -->
        <div class="col-md-5">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-cart-check"></i> Đơn hàng của bạn</h5>
                </div>
                <div class="card-body">
                    @if (Model.CartItems != null && Model.CartItems.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Món ăn</th>
                                        <th class="text-center">SL</th>
                                        <th class="text-end">Giá</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.CartItems)
                                    {
                                        <tr>
                                            <td>
                                                <small>@item.FoodName</small>
                                            </td>
                                            <td class="text-center">@item.Quantity</td>
                                            <td class="text-end">@item.SubTotal.ToString("N0")đ</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <hr />

                        <!-- Tạm tính -->
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-calculator"></i> Tạm tính:</span>
                            <strong id="totalAmount">@Model.TotalAmount.ToString("N0")đ</strong>
                        </div>

                        <!-- Phí ship (động) -->
                        <div class="d-flex justify-content-between mb-2 align-items-center">
                            <span>
                                <i class="bi bi-truck"></i> Phí ship:
                            </span>
                            <span id="shippingLoader" class="spinner-border spinner-border-sm text-primary d-none ms-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                            <div>
                                <strong id="shippingFee" class="text-primary">@Model.ShippingFee.ToString("N0")đ</strong>
                                <span id="freeShippingBadge" class="badge bg-success ms-2 d-none">Miễn phí!</span>
                            </div>
                        </div>

                        <!-- Thông báo miễn phí ship -->
                        <div id="freeShippingAlert" class="alert alert-success alert-sm d-none mb-3">
                            <small>
                                <i class="bi bi-gift"></i> <strong>Miễn phí ship</strong> cho đơn hàng từ 100,000đ!
                            </small>
                        </div>

                        <hr />

                        <!-- Tổng cộng -->
                        <div class="d-flex justify-content-between">
                            <h5><i class="bi bi-cash-stack"></i> Tổng cộng:</h5>
                            <h5 class="text-danger" id="finalTotal">@Model.FinalTotal.ToString("N0")đ</h5>
                        </div>

                        <!-- Thanh toán -->
                        <div class="alert alert-warning mt-3 mb-0">
                            <small>
                                <i class="bi bi-credit-card"></i>
                                <strong>Thanh toán:</strong> Tiền mặt khi nhận hàng (COD)
                            </small>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted">
                            <i class="bi bi-cart-x" style="font-size: 48px;"></i>
                            <br>Giỏ hàng trống
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            // ✅ FIX: Chuyển thành số thay vì chuỗi
            var totalAmount = parseFloat(@Model.TotalAmount);
            var typingTimer;
            var doneTypingInterval = 800; // 0.8 giây sau khi ngừng gõ

            // Lắng nghe sự kiện nhập địa chỉ
            $('#deliveryAddress').on('input', function() {
                clearTimeout(typingTimer);
                var address = $(this).val().trim();

                if (address.length > 0) {
                    typingTimer = setTimeout(function() {
                        calculateShippingFee(address);
                    }, doneTypingInterval);
                }
            });

            // Hàm tính phí ship qua AJAX
            function calculateShippingFee(address) {
                // Hiện loading
                $('#shippingLoader').removeClass('d-none');
                $('#shippingFee').text('Đang tính...');

                $.ajax({
                    url: '/api/shipping/calculate',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        address: address,
                        orderTotal: totalAmount
                    }),
                    success: function(response) {
                        if (response.success) {
                            var shippingFee = parseFloat(response.shippingFee) || 0;
                            var finalTotal = totalAmount + shippingFee; // ✅ Bây giờ là cộng số, không phải nối chuỗi

                            // Cập nhật phí ship
                            $('#shippingFee').text(formatMoney(shippingFee) + 'đ');
                            $('#finalTotal').text(formatMoney(finalTotal) + 'đ');

                            // Hiển thị khu vực
                            if (response.areaName) {
                                $('#areaName').text(response.areaName);

                                if (response.estimatedDistance) {
                                    $('#distanceInfo').html('(~' + response.estimatedDistance + ' km)');
                                } else {
                                    $('#distanceInfo').html('');
                                }

                                $('#shippingAreaInfo').removeClass('d-none');
                            }

                            // Hiển thị miễn phí ship
                            if (response.isFreeShipping) {
                                $('#freeShippingBadge').removeClass('d-none');
                                $('#freeShippingAlert').removeClass('d-none').html(
                                    '<small><i class="bi bi-gift"></i> ' + response.message + '</small>'
                                );
                                $('#shippingFee').addClass('text-decoration-line-through text-muted');
                            } else {
                                $('#freeShippingBadge').addClass('d-none');
                                $('#freeShippingAlert').addClass('d-none');
                                $('#shippingFee').removeClass('text-decoration-line-through text-muted');
                            }
                        }
                    },
                    error: function() {
                        $('#shippingFee').text('15,000đ');
                        var defaultTotal = totalAmount + 15000;
                        $('#finalTotal').text(formatMoney(defaultTotal) + 'đ');
                        console.error('Lỗi khi tính phí ship');
                    },
                    complete: function() {
                        $('#shippingLoader').addClass('d-none');
                    }
                });
            }

            // ✅ Hàm format tiền
            function formatMoney(amount) {
                return Math.round(amount).toLocaleString('vi-VN');
            }

            // Tự động tính khi load trang nếu đã có địa chỉ
            var initialAddress = $('#deliveryAddress').val().trim();
            if (initialAddress.length > 0) {
                calculateShippingFee(initialAddress);
            }
        });
    </script>
}

<style>
    .sticky-top {
        position: sticky;
        z-index: 1020;
    }

    .alert-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .card-header {
        border-bottom: none;
    }
</style>